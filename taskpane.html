/* global Office, document */

Office.onReady(() => {
    // 1. åˆå§‹åŒ–æ™‚ç›´æ¥æŠ“è³‡æ–™
    loadItemData();

    // 2. ç¶å®šæŒ‰éˆ•äº‹ä»¶
    document.getElementById("btnVerify").onclick = markAsVerified;
});

function loadItemData() {
    // å´é‚Šæ¬„å¯ä»¥ç›´æ¥å­˜å–ç›®å‰çš„ Itemï¼Œä¸éœ€è¦ messageParent
    const item = Office.context.mailbox.item;

    // ä½¿ç”¨ Promise.all åŒæ™‚è®€å– To, CC, Attachments
    Promise.all([
        new Promise(r => item.to.getAsync(x => r(x.value || []))),
        new Promise(r => item.cc.getAsync(x => r(x.value || []))),
        new Promise(r => item.getAttachmentsAsync(x => r(x.value || [])))
    ]).then(([to, cc, attachments]) => {
        renderList(to, cc, attachments);
    }).catch(err => {
        console.error(err);
        document.getElementById("recipients-list").innerText = "è®€å–éŒ¯èª¤: " + err.message;
    });
}

function renderList(to, cc, attachments) {
    const rList = document.getElementById("recipients-list");
    const aList = document.getElementById("attachments-list");
    
    rList.innerHTML = "";
    aList.innerHTML = "";

    let hasItems = false;

    // æ¸²æŸ“æ”¶ä»¶äºº (åˆä½µ To å’Œ CC)
    [...to, ...cc].forEach((p, i) => {
        hasItems = true;
        const type = to.includes(p) ? "To" : "Cc"; // ç°¡å–®å€åˆ†
        const div = document.createElement("div");
        div.className = "item-row";
        // ç‚ºäº†ç¢ºä¿ ID å”¯ä¸€ï¼ŒåŠ å€‹å‰ç¶´
        div.innerHTML = `
            <input type='checkbox' class='verify-check' id='r_${i}' onchange='checkAllChecked()'>
            <label for='r_${i}'>
                <span style="font-weight:bold; color:#666">[${type}]</span> 
                ${p.displayName || p.emailAddress}
            </label>
        `;
        rList.appendChild(div);
    });

    if ([...to, ...cc].length === 0) {
        rList.innerHTML = "<div style='padding:5px; font-size:12px'>(ç„¡æ”¶ä»¶äºº)</div>";
    }

    // æ¸²æŸ“é™„ä»¶
    attachments.forEach((a, i) => {
        hasItems = true;
        const div = document.createElement("div");
        div.className = "item-row";
        div.innerHTML = `
            <input type='checkbox' class='verify-check' id='a_${i}' onchange='checkAllChecked()'>
            <label for='a_${i}'>ğŸ“ ${a.name}</label>
        `;
        aList.appendChild(div);
    });

    if (attachments.length === 0) {
        aList.innerHTML = "<div style='padding:5px; font-size:12px'>(ç„¡é™„ä»¶)</div>";
    }

    // é˜²å‘†ï¼šå¦‚æœå®Œå…¨æ²’æ±è¥¿(ä¾‹å¦‚è‡ªå·±å¯„çµ¦è‡ªå·±ä½†æ²’å¡«äºº?)ï¼Œç›´æ¥é–‹é–
    if (!hasItems) {
        enableButton();
    }
}

// æª¢æŸ¥æ˜¯å¦å…¨éƒ¨å‹¾é¸
// å¿…é ˆæ›è¼‰åˆ° window æ‰èƒ½è¢« HTML çš„ onchange å‘¼å«
window.checkAllChecked = function() {
    const all = document.querySelectorAll(".verify-check");
    let pass = true;
    all.forEach(c => { if(!c.checked) pass = false; });
    
    if (pass) enableButton();
    else disableButton();
};

function enableButton() {
    const btn = document.getElementById("btnVerify");
    btn.disabled = false;
    btn.classList.add("active");
    btn.innerText = "âœ… ç¢ºèªç„¡èª¤ (è§£é™¤é–å®š)";
}

function disableButton() {
    const btn = document.getElementById("btnVerify");
    btn.disabled = true;
    btn.classList.remove("active");
    btn.innerText = "è«‹å‹¾é¸æ‰€æœ‰é …ç›®...";
}

function markAsVerified() {
    // å¯«å…¥è‡ªè¨‚å±¬æ€§ isVerified = true
    Office.context.mailbox.item.loadCustomPropertiesAsync((result) => {
        const props = result.value;
        props.set("isVerified", true); // è¨­å®šæ¨™è¨˜
        
        props.saveAsync((saveResult) => {
            if (saveResult.status === Office.AsyncResultStatus.Succeeded) {
                // UI å›é¥‹
                document.getElementById("btnVerify").style.display = "none";
                document.getElementById("status-msg").style.display = "block";
            } else {
                // éŒ¯èª¤è™•ç†
                document.getElementById("btnVerify").innerText = "âŒ å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦";
                console.error(saveResult.error);
            }
        });
    });
}